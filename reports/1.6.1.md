# v1.6.1

# 功能测试

## 主动发送心跳测试

1. 启动 mock server 到一个 linux 机器上：

```bash
go run ./examples/codes/http-sample/server.go
```

2. 启动 mosn proxy：

2.1. mosn 配置

```json
{
  "disable_upgrade" : true,
  "servers":[
    {
      "default_log_path":"stdout",
      "routers":[
        {
          "router_config_name":"server_router",
          "virtual_hosts":[{
            "name":"serverHost",
            "domains": ["*"],
            "routers": [
              {
                "match":{"prefix":"/"},
                "route":{"cluster_name":"serverCluster"}
              }
            ]
          }]
        }
      ],
      "listeners":[
        {
          "name":"serverListener",
          "address": "127.0.0.1:2046",
          "bind_port": true,
          "filter_chains": [{
            "filters": [
              {
                "type": "proxy",
                "config": {
                  "downstream_protocol": "Http1",
                  "upstream_protocol": "Http1",
                  "router_config_name":"server_router"
                }
              }
            ]
          }]
        }
      ]
    }
  ],
  "cluster_manager":{
    "clusters":[
      {
        "name":"serverCluster",
        "type": "SIMPLE",
        "lb_type": "LB_RANDOM",
        "max_request_per_conn": 1024,
        "conn_buffer_limit_bytes":32768,
        "hosts":[
          {"address":"127.0.0.1:8080"} // 这里需要修改成 mock server 的地址
        ],
        "keepalive":{
          "interval": "1s",
          "timeout": "1s"
        }
      }
    ]
  },
  "admin": {
    "address": {
      "socket_address": {
        "address": "0.0.0.0",
        "port_value": 34902
      }
    }
  }
}

```

2.2. 本地 mac 启动 mosn proxy：

```bash
./mosn start -c ./config.json
```

本地 mac ip 是 30.230.84.109


3. 发送请求：

```bash
curl http://127.0.0.1:2046/ # 127.0.0.1:2046 是指启动在本地 macbook 上的 mosn 进程监听的端口
```

4. 模拟网络异常

```bash
sudo iptables -t filter -A OUTPUT -p tcp --sport 8080 -d 30.230.84.109 -j DROP
```

mosn 日志如下，符合预期，多次心跳不同就会主动断开连接

```log
2024-05-29 16:23:30,203 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 25
2024-05-29 16:23:30,219 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 receive response, requestId = 25
2024-05-29 16:23:30,219 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request success 25
2024-05-29 16:23:30,219 [DEBUG] [stream] [xprotocol] [Dispatch] buf.Len() == 0, connection 5 local addr: 30.230.84.109:55470, remote addr: 100.88.107.243:8080
2024-05-29 16:23:31,204 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 26
2024-05-29 16:23:31,204 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 26
2024-05-29 16:23:31,204 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 26
2024-05-29 16:23:31,211 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 receive response, requestId = 26
2024-05-29 16:23:31,211 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request success 26
2024-05-29 16:23:31,211 [DEBUG] [stream] [xprotocol] [Dispatch] buf.Len() == 0, connection 5 local addr: 30.230.84.109:55470, remote addr: 100.88.107.243:8080
2024-05-29 16:23:32,206 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 27
2024-05-29 16:23:32,206 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 27
2024-05-29 16:23:32,207 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 27
2024-05-29 16:23:32,215 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 receive response, requestId = 27
2024-05-29 16:23:32,215 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request success 27
2024-05-29 16:23:32,215 [DEBUG] [stream] [xprotocol] [Dispatch] buf.Len() == 0, connection 5 local addr: 30.230.84.109:55470, remote addr: 100.88.107.243:8080
2024-05-29 16:23:33,208 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 28
2024-05-29 16:23:33,208 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 28
2024-05-29 16:23:33,208 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 28
2024-05-29 16:23:33,217 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 receive response, requestId = 28
2024-05-29 16:23:33,217 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request success 28
2024-05-29 16:23:33,217 [DEBUG] [stream] [xprotocol] [Dispatch] buf.Len() == 0, connection 5 local addr: 30.230.84.109:55470, remote addr: 100.88.107.243:8080
2024-05-29 16:23:34,209 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 29
2024-05-29 16:23:34,209 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 29
2024-05-29 16:23:34,210 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 29
2024-05-29 16:23:34,218 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 receive response, requestId = 29
2024-05-29 16:23:34,218 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request success 29
2024-05-29 16:23:34,218 [DEBUG] [stream] [xprotocol] [Dispatch] buf.Len() == 0, connection 5 local addr: 30.230.84.109:55470, remote addr: 100.88.107.243:8080
2024-05-29 16:23:35,210 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 30
2024-05-29 16:23:35,210 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 30
2024-05-29 16:23:35,211 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 30
2024-05-29 16:23:35,218 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 receive response, requestId = 30
2024-05-29 16:23:35,218 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request success 30
2024-05-29 16:23:35,218 [DEBUG] [stream] [xprotocol] [Dispatch] buf.Len() == 0, connection 5 local addr: 30.230.84.109:55470, remote addr: 100.88.107.243:8080
2024-05-29 16:23:36,212 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 31
2024-05-29 16:23:36,212 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 31
2024-05-29 16:23:36,213 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 31
2024-05-29 16:23:36,223 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 receive response, requestId = 31
2024-05-29 16:23:36,223 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request success 31
2024-05-29 16:23:36,223 [DEBUG] [stream] [xprotocol] [Dispatch] buf.Len() == 0, connection 5 local addr: 30.230.84.109:55470, remote addr: 100.88.107.243:8080
2024-05-29 16:23:37,214 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 32
2024-05-29 16:23:37,214 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 32
2024-05-29 16:23:37,214 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 32
2024-05-29 16:23:38,214 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 33
2024-05-29 16:23:38,214 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 33
2024-05-29 16:23:38,214 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request timeout 32
2024-05-29 16:23:38,214 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 33
2024-05-29 16:23:39,215 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 34
2024-05-29 16:23:39,215 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 34
2024-05-29 16:23:39,215 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request timeout 33
2024-05-29 16:23:39,215 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 34
2024-05-29 16:23:40,216 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request timeout 34
2024-05-29 16:23:40,216 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 35
2024-05-29 16:23:40,216 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 35
2024-05-29 16:23:40,216 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 35
2024-05-29 16:23:41,217 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 36
2024-05-29 16:23:41,217 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request timeout 35
2024-05-29 16:23:41,217 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 36
2024-05-29 16:23:41,217 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 36
2024-05-29 16:23:42,218 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 37
2024-05-29 16:23:42,218 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 37
2024-05-29 16:23:42,219 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request timeout 36
2024-05-29 16:23:42,219 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 37
2024-05-29 16:23:43,218 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request timeout 37
2024-05-29 16:23:43,219 [DEBUG] [network] [close connection] Close TCP Conn, Remote Address is = 100.88.107.243:8080, eventType is = LocalClose
2024-05-29 16:23:43,219 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 38
2024-05-29 16:23:43,219 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 38
2024-05-29 16:23:43,219 [ERROR] [-,-,-] [stream] [xprotocol] endStream, requestId = 38, error = connection has closed
2024-05-29 16:23:43,219 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 38
2024-05-29 16:23:43,219 [DEBUG] [network] [read loop] Error on read. Connection = 5, Local Address = 30.230.84.109:55470, Remote Address = 100.88.107.243:8080, err = read tcp 30.230.84.109:55470->100.88.107.243:8080: use of closed network connection
2024-05-29 16:23:43,220 [DEBUG] [network] [close connection] Close connection 5, event LocalClose, type NoFlush
2024-05-29 16:23:43,220 [DEBUG] [network] receive new connection event LocalClose, try to handle
2024-05-29 16:23:43,220 [DEBUG] client OnEvent LocalClose, connected true
2024-05-29 16:23:48,455 [INFO] [stream] [xprotocol] [keepalive] connection 5 stopped keepalive
2024-05-29 16:23:48,455 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 receive a request timeout 38
2024-05-29 16:23:48,455 [DEBUG] [-,-,-] [stream] [xprotocol] appendHeaders, direction = 0, requestId = 39
2024-05-29 16:23:48,455 [DEBUG] [-,-,-] [stream] [xprotocol] connection 5 endStream, direction = 0, requestId = 39
2024-05-29 16:23:48,455 [ERROR] [-,-,-] [stream] [xprotocol] endStream, requestId = 39, error = connection has closed
2024-05-29 16:23:48,455 [DEBUG] [stream] [xprotocol] [keepalive] connection 5 send a keepalive request, id = 39
```

# 基准测试

+ 使用[sofaload](https://github.com/antJack/sofaload)在本地搭建简单的性能测试

## v1.6.1测试结果

```Bash
./sofaload -D 10 --qps=2000 -c 200 -t 16 -p sofarpc sofarpc://127.0.0.1:12200
starting benchmark...
Application protocol: sofarpc

finished in 10.00s, 2000.00 req/s, 2.41MB/s
requests: 20000 total, 20000 started, 20000 done, 20000 succeeded, 0 failed, 0 errored, 0 timeout
sofaRPC status codes:
	20000 success, 0 error, 0 server exception, 0 unknown
	0 server threadpool busy, 0 error comm, 0 no processor, 0 timeout
	0 client send error, 0 codec exception, 0 connection closed, 0 server serial exception
	0 server deserial exception
traffic: 24.11MB (25280000) total, 390.63KB (400000) headers (space savings 0.00%), 23.73MB (24880000) data
                     min         max         mean         sd        +/- sd
time for request:      126us     11.59ms       261us       370us    98.21%
time for connect:        4us        33us        13us         6us    69.50%
req/s           :       9.50       10.50       10.00        0.41    79.50%

  Latency  Distribution
   50%        203us
   75%        263us
   90%        356us
   95%        449us
   99%       1.18ms
```

## v1.6.0测试结果

```Bash
./sofaload -D 10 --qps=2000 -c 200 -t 16 -p sofarpc sofarpc://127.0.0.1:12200
starting benchmark...
Application protocol: sofarpc

finished in 10.00s, 2000.00 req/s, 2.41MB/s
requests: 20000 total, 20008 started, 20000 done, 20000 succeeded, 0 failed, 0 errored, 0 timeout
sofaRPC status codes:
	20000 success, 0 error, 0 server exception, 0 unknown
	0 server threadpool busy, 0 error comm, 0 no processor, 0 timeout
	0 client send error, 0 codec exception, 0 connection closed, 0 server serial exception
	0 server deserial exception
traffic: 24.11MB (25280000) total, 390.63KB (400000) headers (space savings 0.00%), 23.73MB (24880000) data
                     min         max         mean         sd        +/- sd
time for request:      132us     11.94ms       272us       431us    98.34%
time for connect:        3us        30us        13us         6us    67.00%
req/s           :       9.50       10.60       10.00        0.41    81.50%

  Latency  Distribution
   50%        209us
   75%        274us
   90%        371us
   95%        470us
   99%       1.12m
```